---
- name: Ensure UART overlay is configured in /boot/firmware/config.txt
  ansible.builtin.lineinfile:
    path: /boot/firmware/config.txt
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    insertafter: EOF
  loop:
    - { regexp: '^#?dtoverlay=uart2-pi5', line: 'dtoverlay=uart2-pi5' }
  notify: Reboot required
  tags: gpsd

- name: Install gpsd and clients
  apt:
    name:
      - gpsd
      - gpsd-clients
    state: present
  tags: gpsd

- name: Configure /etc/default/gpsd
  copy:
    dest: /etc/default/gpsd
    content: |
      DEVICES="/dev/ttyAMA2 /dev/pps0"
      GPSD_OPTIONS="-G -n -s 230400"
      USBAUTO="false"
    mode: "0644"
  tags: gpsd

- name: Override gpsd.socket to listen on all interfaces and permissive Unix socket
  ansible.builtin.blockinfile:
    path: /etc/systemd/system/gpsd.socket.d/override.conf
    create: yes
    mode: "0644"
    block: |
      [Socket]
      ListenStream=                  # Need this to clear default first, before...
      ListenStream=/run/gpsd.sock    # setting unix domain socket for local chrony
      ListenStream=2947              # setting listen on any ipv4 or ipv6 address on port 2947
      SocketMode=0666                # Enable non-root to listen
      BindIPv6Only=no                # Bind to both ipv4 and ipv6
    marker: "# {mark} ANSIBLE MANAGED BLOCK - gpsd network access"
  notify:
    - Daemon reload
    - Restart gpsd
  tags: gpsd

- name: Ensure gpsd is enabled and running
  service:
    name: gpsd
    enabled: yes
    state: started
  tags: gpsd


